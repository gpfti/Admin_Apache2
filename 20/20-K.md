
# Tipos de Balaceo de Carga en Apache2

Vamos a enumerar los tipos de **balanceo en Apache2**, suponiendo que temeos **dos servidores backend**, normalmente en direcciones IP diferentes, por ejemplo en las IPs `192.168.1.101:8080` y `192.168.1.102:8080`. Todos se configuran en un VirtualHost de Apache con `mod_proxy_balancer` habilitado.

Para nuestro caso práctico, ambos servidores Apache Tomcat están en la misma máquina y vamos a ilustrar los ejemplos teniendo en cuenta ese contexto. No obstante, lo suyo sería que estuvieran en servidores distintos como es el caso de las direcciones IPs `192.168.1.101:8080` y `192.168.1.102:8080`.

---

## **1. Balanceo `byrequests`**

**Descripción:** Ronda simple; envía las peticiones secuencialmente entre los servidores.

**Configuración:**

```apache
<Proxy "balancer://mi_cluster">
    BalancerMember http://localhost:8080
    BalancerMember http://localhost:8081
    ProxySet lbmethod=byrequests
</Proxy>

ProxyPass "/" "balancer://mi_cluster/"
ProxyPassReverse "/" "balancer://mi_cluster/"
```

**Explicación:** Cada nueva petición se alterna entre los servidores. Ideal si ambos son iguales en potencia y red.

---

## **2. Balanceo `bytraffic`**

**Descripción:** Se basa en la **cantidad total de datos transferidos**.

**Configuración:**

```apache
<Proxy "balancer://mi_cluster">
    BalancerMember http://localhost:8080
    BalancerMember http://localhost:8081
    ProxySet lbmethod=bytraffic
</Proxy>

ProxyPass "/" "balancer://mi_cluster/"
ProxyPassReverse "/" "balancer://mi_cluster/"
```

**Explicación:** Apache irá enviando las peticiones al backend que ha manejado menos tráfico en bytes acumulados. Útil cuando las respuestas pueden variar mucho en tamaño.

---

## **3. Balanceo `bybusyness`**

**Descripción:** Apache envía cada nueva petición al servidor que **tiene menos carga activa** (menos conexiones abiertas).

**Configuración:**

```apache
<Proxy "balancer://mi_cluster">
    BalancerMember http://localhost:8080
    BalancerMember http://localhost:8081
    ProxySet lbmethod=bybusyness
</Proxy>

ProxyPass "/" "balancer://mi_cluster/"
ProxyPassReverse "/" "balancer://mi_cluster/"
```

**Explicación:** Si un servidor se está tardando mucho en responder o tiene muchas conexiones simultáneas, Apache lo evitará temporalmente. Muy útil cuando los servidores no son iguales.

---

## **4. Balanceo `heartbeat`**

**Descripción:** Usa datos en tiempo real de latencia y disponibilidad para repartir la carga. Requiere más configuración.

**Requisitos:**

```bash
sudo a2enmod heartbeat
sudo a2enmod heartmonitor
sudo a2enmod lbmethod_heartbeat
```

**Configuración del monitor (en el servidor Apache principal):**

```apache
<Proxy "balancer://mi_cluster">
    BalancerMember http://localhost:8080 hcping=Heartbeat
    BalancerMember http://localhost:8081 hcping=Heartbeat
    ProxySet lbmethod=heartbeat
</Proxy>

ProxyPass "/" "balancer://mi_cluster/"
ProxyPassReverse "/" "balancer://mi_cluster/"

<Location "/heartbeat">
    SetHandler heartbeat
</Location>

<IfModule heartmonitor_module>
    HeartMonitor /heartbeat 10
</IfModule>
```

**Y en cada backend (los servidores tomcat y tomcat2):**

Agrega una respuesta simple al path `/heartbeat` para que Apache pueda hacer ping.

```bash
# Ejemplo usando netcat o una mini app
```

**Explicación:** Apache revisa la salud de los servidores cada 10 segundos y dirige el tráfico al más eficiente y disponible. Ideal para producción con HA.

---

### **Tabla de métodos de balanceo vs. módulos requeridos**

| Método de Balanceo | Descripción breve                        | Módulos requeridos                                                                                                 |
| ------------------ | ---------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| `byrequests`       | Ronda simple por número de peticiones    | `mod_proxy`, `mod_proxy_balancer`, `mod_proxy_http`, `mod_lbmethod_byrequests`                                     |
| `bytraffic`        | Por tráfico en bytes transferidos        | `mod_proxy`, `mod_proxy_balancer`, `mod_proxy_http`, `mod_lbmethod_bytraffic`                                      |
| `bybusyness`       | Por número de peticiones activas         | `mod_proxy`, `mod_proxy_balancer`, `mod_proxy_http`, `mod_lbmethod_bybusyness`                                     |
| `heartbeat`        | Por estado monitorizado (latencia, etc.) | `mod_proxy`, `mod_proxy_balancer`, `mod_proxy_http`, `mod_lbmethod_heartbeat`, `mod_heartbeat`, `mod_heartmonitor` |

---

### Comando para habilitar todos los módulos necesarios

```bash
sudo a2enmod proxy proxy_balancer proxy_http

# Según el tipo de balanceo:
sudo a2enmod lbmethod_byrequests        # para byrequests
sudo a2enmod lbmethod_bytraffic         # para bytraffic
sudo a2enmod lbmethod_bybusyness        # para bybusyness
sudo a2enmod lbmethod_heartbeat         # para heartbeat
sudo a2enmod heartbeat heartmonitor     # para heartbeat
```

Después de activar los módulos, recuerda reiniciar Apache:

```bash
sudo systemctl restart apache2
```

