
# Conexión Apache2 <> Apache Tomcat

Conectar **Apache HTTP Server** (httpd) con **Apache Tomcat** permite usar Apache como servidor frontal que maneja las peticiones HTTP estáticas (como imágenes, CSS, JS) y redirige las dinámicas (como servlets y JSPs) a Tomcat. Esto se hace principalmente por eficiencia y flexibilidad.

### Formas comunes de conectar Apache con Tomcat:

#### 1. **Usar el módulo `mod_proxy` (recomendado, es el método moderno de conexión)**

Es el método más actual y mantenido. Utiliza `mod_proxy` y `mod_proxy_ajp` o `mod_proxy_http`.

##### a) **Habilita los módulos necesarios**:

En Debian/Ubuntu:

```bash
sudo a2enmod proxy
sudo a2enmod proxy_ajp   # o proxy_http
sudo systemctl restart apache2
```

##### b) **Configura el VirtualHost en Apache**:

```apache
<VirtualHost *:80>
    ServerName midominio.com

    ProxyPass /app ajp://localhost:8009/app
    ProxyPassReverse /app ajp://localhost:8009/app
</VirtualHost>
```

O con HTTP en lugar de AJP (si AJP está deshabilitado):

```apache
<VirtualHost *:80>
    ServerName midominio.com

    ProxyPass /app http://localhost:8080/app
    ProxyPassReverse /app http://localhost:8080/app
</VirtualHost>
```

Suponiendo que haya una app instalada en `http://localhost:8080/app` en Apache Tomcat

##### Apache Tomcat y el protocolo AJP (Apache JServ Protocol)

En el puerto **8009**, por defecto, **Apache Tomcat escucha el protocolo AJP (Apache JServ Protocol)**. Este protocolo se usa para conectar servidores web como **Apache HTTP Server o Nginx** con Tomcat, generalmente en una arquitectura donde:

* **Apache HTTP Server** sirve contenido estático (HTML, imágenes, CSS).
* **Tomcat** sirve contenido dinámico (JSPs, servlets, etc.).
* El tráfico entre Apache y Tomcat viaja por **AJP** en el puerto 8009.

---

### ¿Cómo sé si está activado?

Puedes mirar en el archivo:

```bash
/opt/tomcat/conf/server.xml
```

Busca esta sección:

```xml
<Connector port="8009" protocol="AJP/1.3" redirectPort="8443" />
```

Si esa línea **está comentada**, entonces Tomcat no tiene activo el Conector AJP y por tanto no está escuchando en el puerto 8009.

---

### Verificar si Tomcat escucha en el puerto 8009

Usa este comando:

```bash
sudo ss -tuln | grep 8009
```

Deberías ver una línea como:

```
LISTEN  0  100  *:8009  *:*
```

Si no ves nada, Tomcat no está escuchando ahí. Puede estar desactivado o comentado en `server.xml`.

---

### ¿Debo dejarlo activado?

No necesariamente. **AJP ha tenido vulnerabilidades importantes** (como Ghostcat en 2020), y si **no estás usando Apache o Nginx con AJP**, es más seguro deshabilitarlo.

Para desactivarlo, simplemente comenta o elimina esta línea en `server.xml`:

```xml
<!--
<Connector port="8009" protocol="AJP/1.3" redirectPort="8443" />
-->
```

Luego reinicia Tomcat:

```bash
sudo systemctl restart tomcat
```

##### RECORDATORIO: Comprobar configuración activa en Apache2

Para ver los sitios habilitados en Apache2 en sistemas como Ubuntu/Debian puedes usar:

```bash
ls /etc/apache2/sites-enabled/
```

Este directorio contiene enlaces simbólicos a los archivos reales de configuración que están en:

```bash
/etc/apache2/sites-available/
```

---

### **Ver qué sitios están habilitados y su contenido**

1. **Listar los sitios habilitados:**

```bash
ls -l /etc/apache2/sites-enabled/
```

2. **Ver el contenido de un sitio habilitado:**

```bash
cat /etc/apache2/sites-enabled/000-default.conf
```

o abre el archivo con un editor:

```bash
sudo nano /etc/apache2/sites-enabled/000-default.conf
```

---

### **Comando extra: comprobar configuración activa**

Para ver un resumen de la configuración actual y sitios cargados:

```bash
apache2ctl -S
```

Este comando muestra:

* Qué archivos de configuración están cargados
* Qué VirtualHosts están definidos
* Qué puertos están escuchando
* Y si hay errores de configuración



##### Acceder Apache Tomcat Home y con el protocolo http

Antes habíamos habilitado una serie de módulos de proxy con

```bash
sudo a2enmod proxy
sudo a2enmod proxy_ajp   # o proxy_http
sudo systemctl restart apache2
```

Pero con estos módulos solo, esta configuración que redirige a la Home de Tomcat dará error:


*Archivo apachetomcat.conf en `sites-available` y `sites-enabled` *  
```apache
<VirtualHost *:80>
    ServerName midominio.com

    ProxyPreserveHost On
    ProxyPass / http://localhost:8080/
    ProxyPassReverse / http://localhost:8080/

    ErrorLog ${APACHE_LOG_DIR}/midominio_error.log
    CustomLog ${APACHE_LOG_DIR}/midominio_access.log combined
</VirtualHost>
```

Esta configuracion no tirará Apache, pero dará un error, porque proxy por si solo, no es suficiente, hay que habilitar sub modulos que aportan mas funcionalidades, como proxy_http (que estaba comentado en los dos ejemplos).

Generará un error y la home de apache no cargará. En el log archivado en: `/var/log/apache2/midominio_error.log` veremos una mención de error del tipo *`...If you are using a dso of mod_proxy make sure proxy submodules are included in the configuration load module...`*.

Ese mensaje significa que **si estás cargando `mod_proxy` como módulo dinámico (DSO = Dynamic Shared Object)**, necesitas asegurarte de que también cargas los **submódulos necesarios** de proxy en tu configuración de Apache.

---

## ¿Qué quiere decir esto exactamente?

`mod_proxy` es el módulo base, pero **no hace nada por sí solo**. Necesitas habilitar también los submódulos según el tipo de proxy que vayas a usar:

| Submódulo                 | ¿Para qué sirve?                              |
| ------------------------- | --------------------------------------------- |
| `mod_proxy_http`          | Para proxys hacia servidores HTTP/HTTPS       |
| `mod_proxy_ajp`           | Para proxys hacia Tomcat por AJP              |
| `mod_proxy_balancer`      | Para balanceo de carga                        |
| `mod_lbmethod_byrequests` | Método de balanceo "por número de peticiones" |

---

## ¿Cómo habilitar los submódulos necesarios?

En sistemas basados en Debian/Ubuntu:

```bash
sudo a2enmod proxy
sudo a2enmod proxy_http
sudo a2enmod proxy_balancer
sudo a2enmod lbmethod_byrequests
```

Y luego reinicia Apache:

```bash
sudo systemctl restart apache2
```

---

## Por tanto:

Ese mensaje es solo un recordatorio técnico: **habilita los submódulos correctos según el tipo de proxy que usas**, o Apache no sabrá cómo manejar las instrucciones `ProxyPass`, `BalancerMember`, etc.  
  
Por tanto, tendremos que hacer
```bash
# sudo a2enmod proxy # ya hecho
sudo a2enmod proxy_http
# sudo a2enmod proxy_balancer # no necesario aun
# sudo a2enmod lbmethod_byrequests # no necesario aun
```

Y después

```bash
sudo systemctl restart apache2
```


#### 2. **Usar `mod_jk` (antiguo y menos recomendable ahora)**

Este módulo conecta Apache y Tomcat usando el protocolo AJP, pero está en desuso frente a `mod_proxy`.

##### a) Instalar `mod_jk`:

En Debian/Ubuntu:

```bash
sudo apt-get install libapache2-mod-jk
```

##### b) Configurar `workers.properties`:

Archivo típico en `/etc/libapache2-mod-jk/workers.properties`:

```properties
worker.list=tomcat
worker.tomcat.type=ajp13
worker.tomcat.host=localhost
worker.tomcat.port=8009
```

##### c) Configurar el VirtualHost:

```apache
<VirtualHost *:80>
    ServerName midominio.com
    JkMount /app/* tomcat
</VirtualHost>
```

---

### Recomendaciones:

* **mod\_proxy** es más simple, moderno y mantenido.
* Asegúrate de que Tomcat esté escuchando en el puerto adecuado (por defecto 8080 para HTTP, 8009 para AJP).
* Puedes añadir reglas adicionales para redirigir solo ciertas rutas a Tomcat.



